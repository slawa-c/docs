====== Перенос папки профилей (Users) ======






 
===== На этапе установки =====
<code>
Задача переноса папки профилей пользователей с системного диска на другой логический или физический
диск в ОС семейства Windows стоит весьма остро по ряду причин:

1. Необходимость разделения оперативной информации (система) и архивных данных (данные пользователей)
обусловленная, к примеру, необходимостью хранения системных файлов на высокоскоростном, но менее надежном
массиве дисков RAID0;
2. Отсутствие необходимости дополнительного переноса информации при переустановке ОС.
3. По сравнению с переносом отдельного профиля пользователя перенос папки Users более предпочтителен,
поскольку профили всех последующих пользователей компьютера будут также сохранены в нужном месте, 
и не будет необходимости снова проделывать процедуру переноса.

Одним из наиболее изящных и рациональных методов осуществления такого переноса является возможность определения месторасположения папки профилей пользователей на этапе установки системы. Такую возможность в отношении ОС Windows 7 нам предоставляет Microsoft под названием Audit Mode. Подробнее об этом режиме можно почитать в следующей статье.

Теперь собственно о сценарии переноса папки Users:

    Следует произвести обычную установку Windows 7 любым удобным для Вас способом остановившись на шаге, где программа установщик попросит Вас ввести имя компьютера и имя пользователя.
    Находясь на экране ввода имени компьютера и имени пользователя нажмите сочетание клавиш CTRL + SHIFT + F3. Компьютер будет перезагружен и загрузится уже в режиме Audit Mode. При этом система будет находится в этом режиме до тех пор, пока Вы не запустите утилиту sysprep с ключом /oobe или не выберете соответствующий пункт в оконной версии этой утилиты, которая стартует в Audit Mode каждый раз при запуске системы.
    Поскольку на этот момент Вы уже будете иметь установленную, но не до конца настроенную Windows 7, перед тем как назначать новое месторасположение для папки профилей пользователей, необходимо сперва подготовить дисковую подсистему, то есть произвести создание и форматирование раздела, которые планируется использовать для размещения папки Users.
    Теперь необходимо сформировать конфигурационный файл для настройки местоположения папки Users, вот его содержимое:

    Версия для x64 (загрузить):
    <?xml
    version=«1.0«
    encoding=«utf-8«?>
    <unattend
    xmlns=«urn:schemas-microsoft-com:unattend«>
    <settings
    pass=«oobeSystem«>
    <component
    name=«Microsoft-Windows-Shell-Setup«
    processorArchitecture=«amd64«
    publicKeyToken=«31bf3856ad364e35«
    language=«neutral«
    versionScope=«nonSxS«
    xmlns:wcm=«http://schemas.microsoft.com/WMIConfig/2002/State«
    xmlns:xsi=«http://www.w3.org/2001/XMLSchema-instance«>
    <FolderLocations>
    <ProfilesDirectory>D:\Users</ProfilesDirectory>
    <ProgramData>D:\ProgramData</ProgramData>
    </FolderLocations>
    </component>
    </settings>
    <cpi:offlineImage
    cpi:source=«wim:d:/sources/install.wim#Windows 7 ULTIMATE«
    xmlns:cpi=«urn:schemas-microsoft-com:cpi« />
    </unattend>

    Версия для x86 (загрузить):
    <?xml
    version=«1.0«
    encoding=«utf-8«?>
    <unattend
    xmlns=«urn:schemas-microsoft-com:unattend«>
    <settings
    pass=«oobeSystem«>
    <component
    name=«Microsoft-Windows-Shell-Setup«
    processorArchitecture=«x86«
    publicKeyToken=«31bf3856ad364e35«
    language=«neutral«
    versionScope=«nonSxS«
    xmlns:wcm=«http://schemas.microsoft.com/WMIConfig/2002/State«
    xmlns:xsi=«http://www.w3.org/2001/XMLSchema-instance«>
    <FolderLocations>
    <ProfilesDirectory>D:\Users</ProfilesDirectory>
    <ProgramData>D:\ProgramData</ProgramData>
    </FolderLocations>
    </component>
    </settings>
    <cpi:offlineImage
    cpi:source=«wim:d:/sources/install.wim#Windows 7 PROFESSIONAL«
    xmlns:cpi=«urn:schemas-microsoft-com:cpi« />
    </unattend>

    Сохраните его под любым именем, например, unattend.xml
    Предположим, что файл unattend.xml был сохранен в корне диска C, тогда команда для его применения будет выглядеть следующим образом:

    C:\Windows\System32\sysprep\sysprep.exe /audit /reboot /unattend:C:\unattend.xml

    Компьютер будет перезагружен
    После того как компьютер загрузится выберите в окне sysprep пункт для перезагрузки компьютера в OOBE.
    Вернувшись в к окну задания имени компьютера и имени пользователя проведите установку до конца.
    После загрузки компьютера убедитесь, что папки D:\Users и D:\ProgramData существуют и что папка пользователя, имя которого Вы задали на финишном этапе установки находится в D:\Users.

В качестве бонуса также можно воспользоваться достоинствами так называемых junction points для предотвращения ошибок, связанных с явным указанием прежних путей папок профилей пользователей. Для этого создадим при помощи утилиты mklink две символические ссылки:

mklink /D C:\Users D:\Users
mklink /D C:\ProgramData D:\ProgramData

Таким образом теперь даже при обращении по прежним путям любая программа не заметит подмены и будет работать с папками на диске C, хотя фактически они будут расположены в настроенном Вами месторасположении.
</code>

===== На рабочей системе =====

<code>
Одним из средств умеющих корректно работать с junction points является утилита XXCOPY 
от издателя Pixelab (http://www.xxcopy.com). Она обладает обширным набором функций копирования, 
включающим в себя функции копирования прав доступа, резервного копирования, условного копирования 
и т.п. И конечно же функции для копирования junction points. Для того чтобы в полной мере 
воспользоваться возможностями XXCOPY необходимо использовать версию Pro. Досада здесь заключается в том, 
что она не является бесплатной, однако мы нисколько не нарушим лицензионного соглашения, 
если воспользуемся триальным периодом в 60 дней для наших целей.
</code>

==== Создать временного пользователя ====
<code>
Создать нового пользователя с именем типа TempUser, который будет использован для произведения операции
переноса данных. Перезагрузимся, чтобы очистить блокировки на файлы профилей пользователей и 
входим от имени только что созданного временного пользователя.
</code>

==== Копирование папки Users ====
<code>
xxcopy c:\Users d:\Users /E /H /K /SC /oE1
xxcopy c:\Users d:\Users /E /H /K
</code>

==== Изменение реестра ====
<code>
В реестре следует прописать пути к новому расположению папки профилей пользователей. 
В ветке HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList 
следует изменить ключи 
Default ------------>  D:\Users\Default
ProfilesDirectory -->  D:\Users
Public ------------->  D:\Users\Public

В ветке ProfileList также находятся ветки реестра хранящие параметры пользователей, зарегистрированных в
системе и если мы хотим, чтобы профили существующих пользователей также были корректно перенесены, 
необходимо переписать ключ ProfileImagePath для каждой ветки пользователя.
</code>

==== Перезагрузка ====

==== Создание символических ссылок ====

<code>
После того как мы убедимся, что система загрузилась корректно и профили теперь находятся не на системном
диске, воспользуемся возможностями системы NTFS, которые нам так мешали, в своих целях. 
Создадим на системном диске символические ссылки на новое расположение папки профилей пользователей для
повышения совместимости приложений. Поскольку, как было сказано выше, такие ссылки уже существуют на 
системном диске и junction points нельзя изменять, удалим существующие ссылки и, заодно, 
перенесенную папку пользователей:

D:\Users\Администратор>rd "C:\Documents and Settings"

D:\Users\Администратор>rd "C:\Users" /S
C:\Users, Продолжить [Y(да)/N(нет)]? y

Затем создадим собственно сами ссылки:
    
D:\Users\Администратор>mklink /D "C:\Documents and Settings" "D:\Users"
символическая ссылка создана для C:\Documents and Settings <<===>> D:\Users

D:\Users\Администратор>mklink /D "C:\Users" "D:\Users"
символическая ссылка создана для C:\Users <<===>> D:\Users
</code>
